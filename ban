-- üìå Ban System (C√≥ n√∫t b·∫≠t/t·∫Øt)
-- ƒê·∫∑t trong StarterPlayerScripts
-- RunContext = ClientAndServer

local Players = game:GetService("Players")
local DataStoreService = game:GetService("DataStoreService")
local BanStore = DataStoreService:GetDataStore("BanData")
local player = Players.LocalPlayer

local remote = game.ReplicatedStorage:FindFirstChild("BanRemote") or Instance.new("RemoteEvent")
remote.Name = "BanRemote"
remote.Parent = game.ReplicatedStorage

-- ‚ö° Bi·∫øn ki·ªÉm tra b·∫≠t/t·∫Øt
local systemEnabled = false

-- CLIENT SIDE
if script.RunContext == Enum.RunContext.Client then
	-- GUI n√∫t b·∫≠t/t·∫Øt
	local gui = Instance.new("ScreenGui")
	gui.Name = "BanSystemGUI"
	gui.Parent = player:WaitForChild("PlayerGui")

	local btn = Instance.new("TextButton")
	btn.Size = UDim2.new(0,150,0,50)
	btn.Position = UDim2.new(0.5,-75,0.9,0)
	btn.Text = "Ban System: OFF"
	btn.BackgroundColor3 = Color3.fromRGB(150,0,0)
	btn.TextColor3 = Color3.new(1,1,1)
	btn.Parent = gui
	btn.Active = true
	btn.Draggable = true

	btn.MouseButton1Click:Connect(function()
		systemEnabled = not systemEnabled
		if systemEnabled then
			btn.Text = "Ban System: ON"
			btn.BackgroundColor3 = Color3.fromRGB(0,150,0)
		else
			btn.Text = "Ban System: OFF"
			btn.BackgroundColor3 = Color3.fromRGB(150,0,0)
		end
	end)

	-- G√µ l·ªánh chat
	player.Chatted:Connect(function(msg)
		if not systemEnabled then return end -- üîí Ch∆∞a b·∫≠t th√¨ kh√¥ng d√πng ƒë∆∞·ª£c

		if string.sub(msg,1,5) == "/ban_" then
			local args = string.split(string.sub(msg,6), " ")
			local targetName = args[1]
			local duration = args[2] or "permanent"
			if targetName then
				remote:FireServer("ban", targetName, duration)
			end

		elseif string.sub(msg,1,7) == "/unban_" then
			local targetName = string.sub(msg,8)
			if targetName and targetName ~= "" then
				remote:FireServer("unban", targetName)
			end
		end
	end)
end

-- SERVER SIDE
if script.RunContext == Enum.RunContext.Server then
	local function banPlayer(playerName, duration, banner)
		local key = "Ban_"..playerName
		local expireTime = 0

		if duration == "permanent" then
			expireTime = math.huge
		else
			local minutes = tonumber(duration)
			if minutes then
				expireTime = os.time() + (minutes * 60)
			else
				return false, "Sai ƒë·ªãnh d·∫°ng th·ªùi gian!"
			end
		end

		local success, err = pcall(function()
			BanStore:SetAsync(key, {Expire = expireTime, By = banner})
		end)

		if success then
			local target = Players:FindFirstChild(playerName)
			if target then
				if expireTime == math.huge then
					target:Kick("You have been permanently banned by "..banner)
				else
					target:Kick("You have been banned for "..duration.." minutes by "..banner)
				end
			end
		else
			warn("L·ªói l∆∞u ban: "..err)
		end
	end

	local function unbanPlayer(playerName)
		local key = "Ban_"..playerName
		local success, err = pcall(function()
			BanStore:RemoveAsync(key)
		end)
		if not success then
			warn("L·ªói unban: "..err)
		end
	end

	Players.PlayerAdded:Connect(function(p)
		local key = "Ban_"..p.Name
		local data
		local success, err = pcall(function()
			data = BanStore:GetAsync(key)
		end)

		if success and data then
			if data.Expire == math.huge then
				p:Kick("You are permanently banned by "..(data.By or "Admin"))
			elseif os.time() < data.Expire then
				local remaining = math.floor((data.Expire - os.time())/60)
				p:Kick("You are banned. Remaining: "..remaining.." minutes.")
			else
				BanStore:RemoveAsync(key)
			end
		end
	end)

	remote.OnServerEvent:Connect(function(sender, action, targetName, duration)
		if action == "ban" then
			banPlayer(targetName, duration, sender.Name)
		elseif action == "unban" then
			unbanPlayer(targetName)
		end
	end)
end
